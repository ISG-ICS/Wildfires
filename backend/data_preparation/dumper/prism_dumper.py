import datetime
import logging
from ast import literal_eval as make_tuple
from typing import Tuple, Generator, Union, List, Dict

import psycopg2.errors
import psycopg2.extras
import rootpath

rootpath.append()
from backend.data_preparation.connection import Connection
from backend.data_preparation.dumper.dumperbase import DumperBase

logger = logging.getLogger('TaskManager')


class PRISMDumper(DumperBase):
    def insert(self, data: Dict[str, Dict[str, Dict[Tuple[float, float], float]]]):
        list_data = self.dict2list(data)
        print(list_data)
        for date, long, lat, ppt, tmax, tmean, tmin in list_data:
            Connection.sql_execute_commit(
                f"INSERT INTO prisms values ({repr(str(datetime.datetime.strptime(date, '%Y%m%d')))},st_makepoint({long}, {lat}),{ppt},{tmax}, {tmean}, {tmin}) on conflict do nothing")

    def dict2list(self, data) -> List[Tuple]:
        result = list()
        for time, time_dict in data.items():
            for long, lat in list(time_dict.values())[0]:
                record = [time, long, lat]

                for param, param_dict in time_dict.items():
                    record.append(param_dict[(long, lat)])

                result.append(tuple(record))
                print(result)
        return result


if __name__ == '__main__':
    # check the gps key values
    data = {'20190701': {
        'ppt': {(49.9374999999997, -66.4791666666195): -9999.0, (49.895833333333, -66.4791666666195): -9999.0,
                (49.8541666666663, -66.4791666666195): -9999.0, (49.8124999999996, -66.4791666666195): -9999.0,
                (49.9374999999997, -66.5208333332862): -9999.0, (49.895833333333, -66.5208333332862): -9999.0,
                (49.8541666666663, -66.5208333332862): -9999.0, (49.8124999999996, -66.5208333332862): -9999.0,
                (49.9374999999997, -66.5624999999529): -9999.0, (49.895833333333, -66.5624999999529): -9999.0,
                (49.8541666666663, -66.5624999999529): -9999.0, (49.8124999999996, -66.5624999999529): -9999.0,
                (49.9374999999997, -66.6041666666196): -9999.0, (49.895833333333, -66.6041666666196): -9999.0,
                (49.8541666666663, -66.6041666666196): -9999.0, (49.8124999999996, -66.6041666666196): -9999.0},
        'tmax': {(49.9374999999997, -66.4791666666195): -9999.0, (49.895833333333, -66.4791666666195): -9999.0,
                 (49.8541666666663, -66.4791666666195): -9999.0, (49.8124999999996, -66.4791666666195): -9999.0,
                 (49.9374999999997, -66.5208333332862): -9999.0, (49.895833333333, -66.5208333332862): -9999.0,
                 (49.8541666666663, -66.5208333332862): -9999.0, (49.8124999999996, -66.5208333332862): -9999.0,
                 (49.9374999999997, -66.5624999999529): -9999.0, (49.895833333333, -66.5624999999529): -9999.0,
                 (49.8541666666663, -66.5624999999529): -9999.0, (49.8124999999996, -66.5624999999529): -9999.0,
                 (49.9374999999997, -66.6041666666196): -9999.0, (49.895833333333, -66.6041666666196): -9999.0,
                 (49.8541666666663, -66.6041666666196): -9999.0, (49.8124999999996, -66.6041666666196): -9999.0},
        'tmean': {(49.9374999999997, -66.4791666666195): -9999.0, (49.895833333333, -66.4791666666195): -9999.0,
                  (49.8541666666663, -66.4791666666195): -9999.0, (49.8124999999996, -66.4791666666195): -9999.0,
                  (49.9374999999997, -66.5208333332862): -9999.0, (49.895833333333, -66.5208333332862): -9999.0,
                  (49.8541666666663, -66.5208333332862): -9999.0, (49.8124999999996, -66.5208333332862): -9999.0,
                  (49.9374999999997, -66.5624999999529): -9999.0, (49.895833333333, -66.5624999999529): -9999.0,
                  (49.8541666666663, -66.5624999999529): -9999.0, (49.8124999999996, -66.5624999999529): -9999.0,
                  (49.9374999999997, -66.6041666666196): -9999.0, (49.895833333333, -66.6041666666196): -9999.0,
                  (49.8541666666663, -66.6041666666196): -9999.0, (49.8124999999996, -66.6041666666196): -9999.0},
        'tmin': {(49.9374999999997, -66.4791666666195): -9999.0, (49.895833333333, -66.4791666666195): -9999.0,
                 (49.8541666666663, -66.4791666666195): -9999.0, (49.8124999999996, -66.4791666666195): -9999.0,
                 (49.9374999999997, -66.5208333332862): -9999.0, (49.895833333333, -66.5208333332862): -9999.0,
                 (49.8541666666663, -66.5208333332862): -9999.0, (49.8124999999996, -66.5208333332862): -9999.0,
                 (49.9374999999997, -66.5624999999529): -9999.0, (49.895833333333, -66.5624999999529): -9999.0,
                 (49.8541666666663, -66.5624999999529): -9999.0, (49.8124999999996, -66.5624999999529): -9999.0,
                 (49.9374999999997, -66.6041666666196): -9999.0, (49.895833333333, -66.6041666666196): -9999.0,
                 (49.8541666666663, -66.6041666666196): -9999.0, (49.8124999999996, -66.6041666666196): -9999.0}}}

    dumper = PRISMDumper()
    dump_data = dumper.insert(data)
